name: Build APK for Android

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-apk:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y openjdk-11-jdk zip unzip libncurses5-dev libffi-dev libssl-dev
        sudo update-alternatives --install /usr/bin/java java /usr/lib/jvm/java-11-openjdk-amd64/bin/java 1
        
    - name: Install Python dependencies  
      run: |
        python -m pip install --upgrade pip
        pip install --no-cache-dir buildozer[dev] cython numpy pillow kivy kivymd sqlalchemy reportlab
        
    - name: Set up Buildozer environment
      run: |
        echo "y" | buildozer init
        # ä¿®æ”¹buildozer.specé…ç½®
        sed -i 's/android.sdk_path/#android.sdk_path/' buildozer.spec
        sed -i 's/android.ndk_path/#android.ndk_path/' buildozer.spec
        
    - name: Download Android SDK
      run: |
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip -d android-sdk
        
        # è®¾ç½®SDKçŽ¯å¢ƒå˜é‡
        export ANDROID_HOME=$(pwd)/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        
        # åˆ›å»ºç›®å½•ç»“æž„
        mkdir -p $ANDROID_HOME/cmdline-tools/latest
        mv android-sdk/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest/
        
        # æ·»åŠ åˆ°PATH
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        
    - name: Install Android SDK components
      env:
        ANDROID_HOME: ${{ github.workspace }}/android-sdk
        ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
      run: |
        echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-30"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;30.0.3"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platform-tools"
        
    - name: Configure Buildozer with Android SDK path
      run: |
        echo "" >> buildozer.spec
        echo "[android]" >> buildozer.spec  
        echo "android.sdk_path = ${{ github.workspace }}/android-sdk" >> buildozer.spec
        echo "android.ndk_path = " >> buildozer.spec
        
    - name: Build APK
      env:
        ANDROID_HOME: ${{ github.workspace }}/android-sdk
        ANDROID_SDK_ROOT: ${{ github.workspace }}/android-sdk
        JAVA_HOME: /usr/lib/jvm/java-11-openjdk-amd64
      run: |
        export PATH="$JAVA_HOME/bin:$PATH"
        buildozer android debug
        
    - name: Upload APK artifact
      uses: actions/upload-artifact@v3
      if: success()
      with:
        name: ghlan-apk
        path: bin/*.apk
        retention-days: 30
        
    - name: Create APK Release (on main branch)
      if: github.ref == 'refs/heads/main' && github.event_name == 'push'
      uses: softprops/action-gh-release@v1
      with:
        name: "GHLan APK v${{ github.run_number }}"
        body: |
          ## ðŸ“± GHLanè‡ªå®šä¹‰è¯å…¸ APK
          
          ### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
          - ç‚¹å‡»ä¸‹æ–¹çš„ `.apk` æ–‡ä»¶ä¸‹è½½
          - åœ¨æ‰‹æœºä¸Šå¯ç”¨"æœªçŸ¥æ¥æºå®‰è£…"
          - ç›´æŽ¥å®‰è£…ä½¿ç”¨
          
          ### ðŸ”§ æž„å»ºä¿¡æ¯
          - **æž„å»ºæ—¶é—´**: ${{ github.run_number }}
          - **ä»£ç ç‰ˆæœ¬**: ${{ github.sha }}
          - **è§¦å‘åˆ†æ”¯**: ${{ github.ref_name }}
          
          ### ðŸ“‹ å®‰è£…æ­¥éª¤
          1. ä¸‹è½½ APK æ–‡ä»¶åˆ°æ‰‹æœº
          2. åœ¨è®¾ç½®ä¸­å¯ç”¨"æœªçŸ¥æ¥æºåº”ç”¨"
          3. ç‚¹å‡» APK æ–‡ä»¶å®‰è£…
          4. å¯åŠ¨åº”ç”¨å¼€å§‹ä½¿ç”¨
          
        files: bin/*.apk
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build Summary
      if: always()
      run: |
        echo "## ðŸ—ï¸ æž„å»ºç»“æžœ ##" >> $GITHUB_STEP_SUMMARY
        echo "- **ä½œä¸šçŠ¶æ€**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        
        if [ -d "bin" ] && [ "$(ls -A bin)" ]; then
          echo "- **APKçŠ¶æ€**: âœ… æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "- **ä¸‹è½½**: æŸ¥çœ‹Artifactsæˆ–Releasesä¸‹è½½APK" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **APKçŠ¶æ€**: âŒ æž„å»ºå¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "- **è¯¦ç»†ä¿¡æ¯**: æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        fi
